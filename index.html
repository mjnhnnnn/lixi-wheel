<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V√≤ng Quay L√¨ X√¨ May M·∫Øn</title>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background: url('https://thumbs.dreamstime.com/b/red-envelopes-falling-gold-coins-festive-background-packets-wealth-concept-d-render-chinese-new-year-promotion-437589863.jpg') center/cover no-repeat fixed;
      color: gold;
      text-align: center;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    h1 {
      font-size: 3rem;
      text-shadow: 3px 3px 10px black;
      margin-bottom: 10px;
    }
    #wheel-container {
      position: relative;
      margin: 10px 20px;
    }
    canvas {
      border-radius: 50%;
      box-shadow: 0 0 30px gold;
    }
    #pointer {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 60px;
      color: gold;
      text-shadow: 0 0 10px black;
      pointer-events: none;
      z-index: 10;
    }
    #spin {
      padding: 15px 40px;
      font-size: 1.8rem;
      background: gold;
      color: red;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 5px 15px black;
      margin-top: 10px;
      transition: all 0.2s ease;
    }
    #spin:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 20px black;
    }
    #spin:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: gray;
    }
    #result-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 30;
    }
    #result-modal h2 {
      font-size: 4rem;
      margin-bottom: 20px;
    }
    #result-modal p {
      font-size: 3rem;
      margin: 20px;
    }
  </style>
</head>
<body>

<h1>V√≤ng Quay L√¨ X√¨ May M·∫Øn</h1>

<div id="wheel-container">
  <div id="pointer">‚ñº</div>
  <canvas id="wheel"></canvas>
</div>

<button id="spin">Quay Ngay!</button>

<div id="result-modal">
  <h2>Ch√∫c M·ª´ng NƒÉm M·ªõi!</h2>
  <p>B·∫°n nh·∫≠n ƒë∆∞·ª£c <span id="prize-amount"></span> üßßüéâ</p>
  <button id="close-modal" style="padding:10px 30px;font-size:1.5rem;background:gold;color:red;border:none;border-radius:30px;cursor:pointer;">Quay L·∫°i</button>
</div>

<script>
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const spinBtn = document.getElementById('spin');
const resultModal = document.getElementById('result-modal');
const prizeAmount = document.getElementById('prize-amount');
const closeModal = document.getElementById('close-modal');

/* ======= PRIZES - GI·ªÆ NGUY√äN M√ÄU S·∫ÆC ======= */
const prizes = [
  { text: '10.000ƒë', color: '#FF0000' },
  { text: '20.000ƒë', color: '#FFD700' },
  { text: '50.000ƒë', color: '#FF4500' },
  { text: '100.000ƒë', color: '#DAA520' },
  { text: '500.000ƒë', color: '#FF1493' },
  { text: '1.000.000ƒë', color: '#8A2BE2' },
  { text: '5.000.000ƒë', color: '#000000' }
];

// V√≤ng quay ƒë∆∞·ª£c chia ƒê·ªÄU 7 ph·∫ßn (cho ƒë·∫πp)
const numSegments = prizes.length;
const anglePerSegment = (Math.PI * 2) / numSegments;

const segments = [];
for (let i = 0; i < numSegments; i++) {
  segments.push({
    text: prizes[i].text,
    color: prizes[i].color,
    index: i, // L∆∞u index ƒë·ªÉ d·ªÖ mapping
    start: i * anglePerSegment,
    end: (i + 1) * anglePerSegment
  });
}

let currentRotation = 0;
let isSpinning = false;

function resizeCanvas() {
  const size = Math.min(window.innerWidth * 0.85, window.innerHeight * 0.7);
  canvas.width = size;
  canvas.height = size;
  drawWheel();
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function drawWheel() {
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const radius = cx - 30;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate(currentRotation);

  segments.forEach(seg => {
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.arc(0, 0, radius, seg.start, seg.end);
    ctx.closePath();
    ctx.fillStyle = seg.color;
    ctx.fill();
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 3;
    ctx.stroke();

    const mid = seg.start + (seg.end - seg.start)/2;
    ctx.save();
    ctx.rotate(mid);
    ctx.textAlign = 'center';
    ctx.fillStyle = 'white';
    ctx.font = `bold ${canvas.width/25}px Arial`;
    ctx.textBaseline = 'middle';
    ctx.fillText(seg.text, radius * 0.65, 0);
    ctx.restore();
  });

  ctx.restore();

  ctx.beginPath();
  ctx.arc(cx, cy, 40, 0, Math.PI*2);
  ctx.fillStyle = '#222';
  ctx.fill();
}

spinBtn.onclick = () => {
  if (isSpinning) return;

  isSpinning = true;
  spinBtn.disabled = true;
  resultModal.style.display = 'none';

  // Reset g√≥c quay v·ªÅ 0-2PI ƒë·ªÉ tr√°nh c·ªông d·ªìn
  currentRotation = currentRotation % (Math.PI * 2);

  fetch('/.netlify/functions/get-prize')
    .then(res => res.json())
    .then(data => {
      const winningText = data.prize;

      // T√¨m index c·ªßa √¥ th·∫Øng (d·ª±a tr√™n text)
      const winningIndex = prizes.findIndex(p => p.text === winningText);
      if (winningIndex === -1) {
        // Fallback n·∫øu kh√¥ng t√¨m th·∫•y
        winningIndex = 0;
      }

      // L·∫•y segment t∆∞∆°ng ·ª©ng (v·∫Ω ƒë·ªÅu)
      const winningSeg = segments[winningIndex];
      const segMidAngle = winningSeg.start + (winningSeg.end - winningSeg.start)/2;
      const pointerAngle = Math.PI/2; // Kim ch·ªâ xu·ªëng d∆∞·ªõi

      const extraSpins = 6 + Math.floor(Math.random() * 4); // 6-9 v√≤ng

      // T√≠nh target rotation: ƒë∆∞a √¥ th·∫Øng v·ªÅ d∆∞·ªõi kim
      const targetRotation = 
        extraSpins * Math.PI * 2 +
        (Math.PI * 2 - segMidAngle - pointerAngle);

      const duration = 6000;
      const start = Date.now();
      const startRotation = currentRotation;

      function animate() {
        const progress = Math.min((Date.now()-start)/duration,1);
        const ease = 1 - Math.pow(1-progress,4);

        currentRotation = startRotation + (targetRotation - startRotation) * ease;
        drawWheel();

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          isSpinning = false;
          prizeAmount.textContent = winningText;
          resultModal.style.display = 'flex';

          let particle = 150;
          let spread = 70;

          if (winningText === '500.000ƒë') { particle=400; spread=90; }
          if (winningText === '1.000.000ƒë') { particle=700; spread=120; }
          if (winningText === '5.000.000ƒë') { particle=1200; spread=150; }

          confetti({
            particleCount: particle,
            spread: spread,
            origin: { y: 0.6 }
          });

          spinBtn.disabled = false;
        }
      }
      animate();
    })
    .catch(() => {
      alert("L·ªói k·∫øt n·ªëi server!");
      isSpinning = false;
      spinBtn.disabled = false;
    });
};

closeModal.onclick = () => {
  resultModal.style.display = 'none';
  spinBtn.disabled = false;
};

drawWheel();
</script>

</body>
</html>