<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>V√≤ng Quay L√¨ X√¨ May M·∫Øn</title>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Arial', sans-serif;
      background: url('https://thumbs.dreamstime.com/b/red-envelopes-falling-gold-coins-festive-background-packets-wealth-concept-d-render-chinese-new-year-promotion-437589863.jpg') center/cover no-repeat fixed;
      color: gold;
      text-align: center;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    h1 {
      font-size: 3rem;
      text-shadow: 3px 3px 10px black;
      margin-bottom: 10px;
    }
    #wheel-container { position: relative; margin: 10px 20px; }
    canvas { border-radius: 50%; box-shadow: 0 0 30px gold; }
    #pointer {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 60px;
      z-index: 10;
    }
    #spin {
      padding: 15px 40px;
      font-size: 1.8rem;
      background: gold;
      color: red;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 5px 15px black;
      margin-top: 10px;
    }
    #spin:disabled { opacity: 0.6; background: gray; }
    #limit-message { font-size: 1.5rem; margin-top: 20px; display: none; }
    #result-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 30;
    }
    #result-modal h2 { font-size: 4rem; }
    #result-modal p { font-size: 3rem; margin: 20px; }
  </style>
</head>
<body>

<h1>V√≤ng Quay L√¨ X√¨ May M·∫Øn</h1>

<div id="wheel-container">
  <div id="pointer">‚ñº</div>
  <canvas id="wheel"></canvas>
</div>

<button id="spin">Quay Ngay!</button>
<div id="limit-message">H·∫øt l∆∞·ª£t quay h√¥m nay r·ªìi, mai quay ti·∫øp nh√©! üßß</div>

<div id="result-modal">
  <h2>Ch√∫c M·ª´ng NƒÉm M·ªõi!</h2>
  <p>B·∫°n nh·∫≠n ƒë∆∞·ª£c <span id="prize-amount"></span> üßßüéâ</p>
  <button id="close-modal">Quay L·∫°i</button>
</div>

<script>
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const spinBtn = document.getElementById('spin');
const resultModal = document.getElementById('result-modal');
const prizeAmount = document.getElementById('prize-amount');
const closeModal = document.getElementById('close-modal');
const limitMessage = document.getElementById('limit-message');

const MAX_SPINS_PER_DAY = 3;

function getTodayDate() {
  const d = new Date();
  return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
}

let spinData = JSON.parse(localStorage.getItem('spinData')) || { date: getTodayDate(), count: 0 };
if (spinData.date !== getTodayDate()) {
  spinData = { date: getTodayDate(), count: 0 };
  localStorage.setItem('spinData', JSON.stringify(spinData));
}

function updateSpinLimit() {
  if (spinData.count >= MAX_SPINS_PER_DAY) {
    spinBtn.disabled = true;
    limitMessage.style.display = 'block';
  } else {
    spinBtn.disabled = false;
    limitMessage.style.display = 'none';
  }
}
updateSpinLimit();

const prizes = [
  { text: '10.000ƒë', color: '#FF0000' },
  { text: '20.000ƒë', color: '#FFD700' },
  { text: '50.000ƒë', color: '#FF4500' },
  { text: '100.000ƒë', color: '#DAA520' },
  { text: '500.000ƒë', color: '#FF1493' },
  { text: '1.000.000ƒë', color: '#8A2BE2' },
  { text: '5.000.000ƒë', color: '#000000' }
];

const segments = [];
const numSegments = prizes.length;
const anglePerSegment = (Math.PI * 2) / numSegments;

for (let i = 0; i < numSegments; i++) {
  segments.push({
    text: prizes[i].text,
    color: prizes[i].color,
    start: i * anglePerSegment,
    end: (i + 1) * anglePerSegment
  });
}

let currentRotation = 0;
let isSpinning = false;

function resizeCanvas() {
  const size = Math.min(window.innerWidth * 0.85, window.innerHeight * 0.7);
  canvas.width = size;
  canvas.height = size;
  drawWheel();
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function drawWheel() {
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const radius = cx - 30;

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.save();
  ctx.translate(cx, cy);
  ctx.rotate(currentRotation);

  segments.forEach(seg => {
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.arc(0, 0, radius, seg.start, seg.end);
    ctx.closePath();
    ctx.fillStyle = seg.color;
    ctx.fill();
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 3;
    ctx.stroke();

    const mid = (seg.start + seg.end) / 2;
    ctx.save();
    ctx.rotate(mid);
    ctx.textAlign = 'center';
    ctx.fillStyle = 'white';
    ctx.font = `bold ${canvas.width/25}px Arial`;
    ctx.textBaseline = 'middle';
    ctx.fillText(seg.text, radius * 0.65, 0);
    ctx.restore();
  });

  ctx.restore();
}

spinBtn.onclick = () => {
  if (isSpinning || spinData.count >= MAX_SPINS_PER_DAY) return;

  isSpinning = true;
  spinBtn.disabled = true;
  resultModal.style.display = 'none';

  fetch('/.netlify/functions/get-prize')
    .then(res => res.json())
    .then(data => {

      const winningSeg = segments.find(s => s.text === data.prize);
      if (!winningSeg) return;

      const segCenter = (winningSeg.start + winningSeg.end) / 2;

      const pointerAngle = -Math.PI / 2; // 12 gi·ªù
      const spins = 6 + Math.random() * 2;

      // chu·∫©n h√≥a g√≥c hi·ªán t·∫°i
      const normalized = currentRotation % (Math.PI * 2);

      // t√≠nh delta ch√≠nh x√°c
      let delta = pointerAngle - (segCenter + normalized);
      delta = (delta + Math.PI * 2) % (Math.PI * 2);

      const targetRotation = currentRotation + spins * Math.PI * 2 + delta;

      const duration = 6000;
      const start = Date.now();
      const initial = currentRotation;

      function animate() {
        const progress = Math.min((Date.now() - start) / duration, 1);
        const ease = 1 - Math.pow(1 - progress, 4);

        currentRotation = initial + (targetRotation - initial) * ease;
        drawWheel();

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {

          // reset ch·ªëng t√≠ch l≈©y
          currentRotation = currentRotation % (Math.PI * 2);

          isSpinning = false;
          prizeAmount.textContent = data.prize;
          resultModal.style.display = 'flex';

          spinData.count++;
          localStorage.setItem('spinData', JSON.stringify(spinData));
          updateSpinLimit();
        }
      }

      animate();
    });
};

closeModal.onclick = () => {
  resultModal.style.display = 'none';
  updateSpinLimit();
};

drawWheel();
</script>
</body>
</html>