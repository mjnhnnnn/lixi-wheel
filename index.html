<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VÃ²ng Quay LÃ¬ XÃ¬ May Máº¯n</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:url('https://thumbs.dreamstime.com/b/red-envelopes-falling-gold-coins-festive-background-packets-wealth-concept-d-render-chinese-new-year-promotion-437589863.jpg') center/cover no-repeat fixed;
  color:gold;
  text-align:center;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
#wheel-container{position:relative;}
#pointer{
  position:absolute;
  top:-10px;
  left:50%;
  transform:translateX(-50%);
  font-size:60px;
  z-index:10;
}
canvas{border-radius:50%;box-shadow:0 0 30px gold;}
button{
  padding:15px 40px;
  font-size:1.5rem;
  background:gold;
  color:red;
  border:none;
  border-radius:50px;
  cursor:pointer;
  margin-top:15px;
}
#result-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.85);
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
}
</style>
</head>
<body>

<h1>VÃ²ng Quay LÃ¬ XÃ¬ May Máº¯n</h1>

<div id="wheel-container">
<div id="pointer">â–¼</div>
<canvas id="wheel"></canvas>
</div>

<button id="spin">Quay Ngay!</button>

<div id="result-modal">
<h2>ChÃºc Má»«ng NÄƒm Má»›i!</h2>
<p>Báº¡n nháº­n Ä‘Æ°á»£c <span id="prize-amount"></span> ðŸ§§ðŸŽ‰</p>
<button onclick="closeModal()">Quay Láº¡i</button>
</div>

<script>
const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const spinBtn = document.getElementById("spin");
const resultModal = document.getElementById("result-modal");
const prizeAmount = document.getElementById("prize-amount");

const prizes = [
{ text:"10.000Ä‘", color:"#FF0000" },
{ text:"20.000Ä‘", color:"#FFD700" },
{ text:"50.000Ä‘", color:"#FF4500" },
{ text:"100.000Ä‘", color:"#DAA520" },
{ text:"500.000Ä‘", color:"#FF1493" },
{ text:"1.000.000Ä‘", color:"#8A2BE2" },
{ text:"5.000.000Ä‘", color:"#000000" }
];

let segments=[];
let currentRotation=0;
let isSpinning=false;

function initWheel(){
  const num=prizes.length;
  const angle=(Math.PI*2)/num;
  segments=[];
  for(let i=0;i<num;i++){
    segments.push({
      text:prizes[i].text,
      color:prizes[i].color,
      start:i*angle,
      end:(i+1)*angle
    });
  }
}

function resize(){
  const size=Math.min(window.innerWidth*0.8,window.innerHeight*0.7);
  canvas.width=size;
  canvas.height=size;
  draw();
}
window.addEventListener("resize",resize);

function draw(){
  const cx=canvas.width/2;
  const cy=canvas.height/2;
  const r=cx-20;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(currentRotation);

  segments.forEach(seg=>{
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,r,seg.start,seg.end);
    ctx.closePath();
    ctx.fillStyle=seg.color;
    ctx.fill();
    ctx.strokeStyle="white";
    ctx.stroke();

    const mid=(seg.start+seg.end)/2;
    ctx.save();
    ctx.rotate(mid);
    ctx.fillStyle="white";
    ctx.font=`bold ${canvas.width/28}px Arial`;
    ctx.textAlign="center";
    ctx.fillText(seg.text,r*0.65,0);
    ctx.restore();
  });

  ctx.restore();
}

spinBtn.onclick=()=>{
  if(isSpinning) return;
  isSpinning=true;
  spinBtn.disabled=true;

  fetch("/.netlify/functions/get-prize")
  .then(r=>r.json())
  .then(data=>{
    const result=data.prize;
    const segment=segments.find(s=>s.text===result);

    if(!segment){
      alert("Prize mismatch backend!");
      return;
    }

    const segmentCenter=(segment.start+segment.end)/2;

    // Kim chá»‰ á»Ÿ vá»‹ trÃ­ 12h = -90deg ( -Ï€/2 )
    const pointerAngle=-Math.PI/2;

    const spins=6+Math.random()*2;

    const finalAngle=
      spins*Math.PI*2
      + (pointerAngle - segmentCenter);

    animateSpin(finalAngle,result);
  });
};

function animateSpin(target,result){
  const start=performance.now();
  const duration=5000;
  const initial=currentRotation;

  function frame(time){
    const progress=Math.min((time-start)/duration,1);
    const ease=1-Math.pow(1-progress,3);

    currentRotation=initial+(target-initial)*ease;
    draw();

    if(progress<1){
      requestAnimationFrame(frame);
    }else{
      // RESET Ä‘á»ƒ trÃ¡nh tÃ­ch lÅ©y
      currentRotation=currentRotation%(Math.PI*2);

      isSpinning=false;
      spinBtn.disabled=false;
      prizeAmount.textContent=result;
      resultModal.style.display="flex";

      confetti({
        particleCount: result==="5.000.000Ä‘"?1000:200,
        spread: result==="5.000.000Ä‘"?150:80
      });
    }
  }
  requestAnimationFrame(frame);
}

function closeModal(){
  resultModal.style.display="none";
}

initWheel();
resize();
</script>
</body>
</html>